<!DOCTYPE html>
<html>
<head>
<meta charset="ISO-8859-1">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Derivative Trade Strategy Calculator</title>
<script type="text/javascript" data-main="main" src="./require.js"></script>
<link rel="stylesheet" href="jquery-ui.css">
<link rel="stylesheet" href="dfm.css">
<link rel="stylesheet"
	href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
<!-- <script type="text/javascript" src="jquery-3.1.0.min.js"></script>
<script src="jquery-ui.js"></script>
 -->
<!-- <script
	src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script> -->
</head>
<body>
	<nav class="navbar navbar-inverse">
		<div class="container-fluid">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle" data-toggle="collapse"
					data-target="#myNavbar">
					<span class="icon-bar"></span> <span class="icon-bar"></span> <span
						class="icon-bar"></span>
				</button>
				<a class="navbar-brand" id="application" href="#">Derivative
					Strategy Calculator</a>
			</div>
			<div class="collapse navbar-collapse" id="myNavbar">
				<ul class="nav navbar-nav navbar-right">
					<li class="fb-login-button" data-size="large"
						data-show-faces="false" data-auto-logout-link="false"
						data-onlogin="initialize()"
						style="margin-top: 12px; display: none"></li>
					<li id="fbLogout" onclick="fbLogout()" style="display: none"><a
						class="fb_button fb_button_medium"><span
							class="fb_button_text">Logout</span></a></li>
				</ul>
			</div>
		</div>
	</nav>
	<div id="group" class="container-fluid">
		<div class="row">
			<div class="col-md-3">
				<div class="input" id="input" style="display: none">
					<form id="addForm" class="add_form">
						<div class="form-group row ui-widget">
							<label class="sr-only" for="instrument">Instrument:</label>
							<div class="col-md-10">
								<input style="text-transform: uppercase" type="text"
									class="form-control" id="instrument"
									placeholder="Stock / Index">
							</div>
						</div>
						<div class="form-group row ">
							<label class="sr-only" for="instrument">LotSize:</label>
							<div class="col-md-4">
								<input type="number" class="form-control" id="lotSize"
									placeholder="Lot Size" readonly="readonly">
							</div>
							<div class="col-md-6">
								<input type="number" class="form-control" id="centralStrike"
									placeholder="Central Strike">
							</div>
						</div>
						<div class="form-group row">
							<label class="sr-only" for="type">Instrument Type:</label>
							<div class="col-md-6">
								<select class="form-control" id="type">
									<option id="future" value="Future">Future</option>
									<option id="call" value="Call Option">Option ( Call )</option>
									<option id="put" value="Put Option">Option ( Put )</option>
								</select>
							</div>
						</div>
						<div class="form-group row">
							<label class="sr-only" for="strike">StrikePrice:</label>
							<div class="col-md-6">
								<input type="number" class="form-control" id="strike"
									placeholder="Strike price">
							</div>
						</div>
						<div class="form-group">
							<label class="radio-inline"><input title="Buy" id="buy"
								type="radio" name="optradio" checked>Buy</label> <label
								class="radio-inline"><input title="Sell" id="sell"
								type="radio" name="optradio">Sell</label>
						</div>
						<div class="form-group row">
							<label class="sr-only" for="price">Price:</label>
							<div class="col-md-8">
								<input type="number" class="form-control" id="price"
									placeholder="Instrument price">
							</div>
						</div>
						<div class="form-group row">
							<button type="submit"
								style="margin-left: 15px; margin-bottom: 0px"
								class="btn btn-primary col-md-3" id="addButton"
								disabled="disabled">Add</button>
						</div>
					</form>
				</div>
				<div id="video" style="display: none">
					<iframe width="100%" height="293"
						src="https://www.youtube.com/embed?listType=search&list=cnbc-tv18&autoplay=1"
						allowfullscreen></iframe>
				</div>
			</div>
			<div id="output" class="col-md-9" style="display: none">
				<div id="instrumentArea" class="instrumentarea">
					<div class="table-responsive" id="instrumentReference"></div>
				</div>
				<div id="outputArea">
					<ul class="nav nav-tabs">
						<li class="active"><a data-toggle="tab" href="#table">P
								&amp; L Table</a></li>
						<li><a data-toggle="tab" href="#graph">P &amp; L
								Graphical</a></li>
					</ul>
					<div class="tab-content">
						<div id="table" class="tab-pane fade in active chartarea">
							<div class="table-responsive" id="outputReference"></div>
						</div>
						<div id="graph" class="tab-pane fade">
							<canvas class=" chartarea" id="chart"></canvas>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div id="statusbar" class="row" style="display: none">
			<div class="col-md-12">
				<div class="status">
					<div class="marquee">
						<div>
							<span class="small" id="span1"></span><span class="small"
								id="span2"></span>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div id="about" style="display: none">
		<div class="well">
			<p>Trade strategy calculator calculates the profit and loss at
				range of underlying values. A strategy could be formed of multiple
				legs using varied future and option combinations.</p>
			<p>The instrument editor on the left side is used to add strategy
				legs which appear on the right side table at the top. Click
				'Calculate' button to compute the profit and loss figures</p>
			<p class="em small">Click on the title above to return></p>
		</div>
	</div>
	<script type="text/javascript">
	require.config({
		baseUrl : '.',
		paths : {
			'jquery' : 'jquery-3.1.0.min',
			'chartjs' : 'Chart.bundle.min',
			'jqueryui' : 'jquery-ui.min',
			'bootstrap' : 'bootstrap.min',
			'Facebook': '//connect.facebook.net/en_US/sdk',
			'Firebase' : '//www.gstatic.com/firebasejs/3.6.2/firebase'
		},
		shim : {
			/* Set bootstrap dependencies (just jQuery) */
			'jqueryui' : [ 'jquery' ],
		    'bootstrap' : [ 'jquery' ],
		    'Facebook' : {
		        exports: 'FB'
		      },
		    'Firebase': {
		        exports: 'firebase'
		      }
		}
	});
		require(
				[ 'Config','FOInstrument', 'FOInstrumentStore', 'InstrumentTable','Contract','MarketData','ContractData','Facebook','Firebase','jquery','jqueryui','bootstrap' ],
				function(config,foInstrument, foInstrumentStore, instrumentTable,contract,marketData,contractData,facebook,firebase,$,autocomplete) {
				  facebook.init(config.getFacebookConfig(config.mode));
				  firebase.initializeApp(config.getFirebaseConfig(config.mode));
				  var status = undefined;
				  facebook.Event.subscribe('auth.authResponseChange', checkLoginState);
				  this.fbLogout = function() {
				        FB.logout(function (response) {
				        	$('#fbLogout').hide();
				  			$('.fb-login-button').show();
				  			$('#video').hide();
				  			$('#output').hide();
				  			$('#statusbar').hide();
				  			$('#input').hide();
				        });
				    }
				  this.initialize = function() {
			  			$('.fb-login-button').hide();
			  			$('#fbLogout').show();
			  			$('#video').show();
			  			$('#output').show();
			  			$('#statusbar').show();
			  			//facebook.logout();
						foInstrumentStore.load(foInstrumentStore,function() {
							contract.call(onSuccess);
							var rowNumber = foInstrumentStore.length();
							if(rowNumber != 0) {
								$('#computeButton').removeAttr('disabled'); 
							} else {
								$('#computeButton').attr('disabled', 'disabled');					
							}
							instrumentTable.show();
							instrumentTable.compute();
							var repeat = function() {
									marketData.call();
									setTimeout(repeat, 30000, true);
							};
							repeat();
						});
				  }
				  facebook.getLoginStatus(function(response) {
				  		console.log('status is --- ' + response.status);
				  		status = response.status;
					    console.log('Facebook response --- ' + response);
					});
				  if(status != 'connected') {
				  	facebook.login(function(response) {
				  		if(response.status == 'connected') {
				  			console.log('user is connected');
				  			$('#fbLogout').show();
				  		} else {
				  			$('.fb-login-button').show();
				  			return;
				  		}
				  	});
				   }  else
					   $('#fbLogout').show(); 
				  function checkLoginState(event) {
					  if (event.authResponse) {
					    // User is signed-in Facebook.
					    var unsubscribe = firebase.auth().onAuthStateChanged(function(firebaseUser) {
					      unsubscribe();
					      // Check if we are already signed-in Firebase with the correct user.
					      if (!isUserEqual(event.authResponse, firebaseUser)) {
					        // Build Firebase credential with the Facebook auth token.
					        var credential = firebase.auth.FacebookAuthProvider.credential(
					            event.authResponse.accessToken);
					        // Sign in with the credential from the Facebook user.
					        firebase.auth().signInWithCredential(credential).catch(function(error) {
					          // Handle Errors here.
					          var errorCode = error.code;
					          var errorMessage = error.message;
					          // The email of the user's account used.
					          var email = error.email;
					          // The firebase.auth.AuthCredential type that was used.
					          var credential = error.credential;
					          // ...
					        }).then(function() { initialize(); });
					        //initialize();
					      } else {
					        // User is already signed-in Firebase with the correct user.
					    	  initialize();
					      }
					    });
					  } else {
					    // User is signed-out of Facebook.
					    firebase.auth().signOut();
					  }
					}
				  function isUserEqual(facebookAuthResponse, firebaseUser) {
					  if (firebaseUser) {
					    var providerData = firebaseUser.providerData;
					    for (var i = 0; i < providerData.length; i++) {
					      if (providerData[i].providerId === firebase.auth.FacebookAuthProvider.PROVIDER_ID &&
					          providerData[i].uid === facebookAuthResponse.userID) {
					        // We don't need to re-auth the Firebase connection.
					        return true;
					      }
					    }
					  }
					  return false;
					}
				  var onSuccess = function() {
						var keys = contract.getKeyArray();
						$('#instrument').autocomplete({ source: function( request, response ) {
						     var matcher = new RegExp( "^" + $.ui.autocomplete.escapeRegex( request.term ), "i" );
						     response( $.grep( keys, function( item ){
						       return matcher.test( item );
						     }) );
						   } });
						$("#lotSize").attr('readonly',true); 
						$("#centralStrike").attr('readonly',true); 
						$('#input').show();
						console.log('contracts - ' + JSON.stringify(keys));
					}
					$('#addButton')
							.click(
									function() {
										var sel = $("select option:selected")
												.val();
										var strike = sel != 'Future' ? $(
												'#strike').val() : '';
										var action;
										if ($("#buy").prop('checked') == true)
											action = 'Buy';
										else
											action = 'Sell';
										var exchange = 'NSE';
										var lotSize = $('#lotSize').val();
										var centralStrike = $('#centralStrike').val();
										var foArray = foInstrumentStore.getArray();
										var keyNo = 0, found = false;
										do {
											keyNo += 1;
											found = false;
											for(var i = 0; i < foArray.length; i++) {
												if(('key' + keyNo).localeCompare(foArray[i].id) == 0) {
													found = true;
													break;
												}
											}
										} while(found == true);
										var id = 'key' + keyNo;
										console.log('new key added is ' + id);
										var price = $('#price').val();
										var name = $('#instrument').val().toUpperCase();
										var conData = contract.get(name);
										var foInst = new foInstrument(exchange,id,name,sel,strike,action,price,lotSize,centralStrike,true,conData.tickSize);
										foInstrumentStore.add(id,foInst);
										instrumentTable.show();
										foInstrumentStore.save();
										$('#addForm')[0].reset();
										var array = foInstrumentStore.getArray();
										var foFirstInst = array[0];
										$('#instrument').val(name);
										$('#lotSize').val(lotSize);
										$('#centralStrike').val(centralStrike);
										$('#strike').hide();
										$('#strike').val('100');
										$('#addButton').attr('disabled', 'disabled');
										instrumentTable.compute();
										$('#computeButton').removeAttr('disabled'); 
									});
					$('#instrumentReference').on('click','#delete',function() {
						console.log('Delete link clicked with data ' + $(this).data('key'));
						foInstrumentStore.delete($(this).data('key'));
						foInstrumentStore.save();
						instrumentTable.show();
						var rowNumber = foInstrumentStore.length();
						if(rowNumber == 0) {
							$('#instrument').attr('readonly', false);
							/* $('#lotSize').attr('readonly', false);
							$('#centralStrike').attr('readonly', false); */
							$('#instrument').val('');
							$('#lotSize').val('');
							$('#centralStrike').val('');
							$('#computeButton').attr('disabled', 'disabled');
							$('#outputTable').remove();
						} /* else { */
							instrumentTable.compute();
						/* } */
					});
					$('#instrumentReference').on('change','#active',function() {
						var id =  $(this).data('id');
						console.log('Checkbox clicked with data ' + id);
						var foInstrument = foInstrumentStore.get(id);
						if(foInstrument != undefined) {
							foInstrument.active = $(this).is(':checked');
							foInstrumentStore.save();
							instrumentTable.compute();
						}
					});
					$('#computeButton').click(function() {
						instrumentTable.compute();
					});
					$('#application').click(function() {
						if ($('#about').is(":visible")) {
							$('#group').show();
							$('#about').hide();
						} else {
							$('#group').hide();
							$('#about').show();
						}
					});
					$('#instrument').focusout(function() {
						var instrument = $('#instrument').val().trim().toUpperCase();
						if(instrument != '') {
							var data = contract.get(instrument);
							var lotSize = data.lotSize;
							if(lotSize != undefined) {
								$('#lotSize').val(lotSize);
								$('#centralStrike').val(data.centralStrike); //Math.round(650000/lotSize));
							} else {
								$('#lotSize').val('');
								$('#centralStrike').val('');
							}
						}
					});
					$("select#type").change(function() {
						var str = "";
						$("select option:selected").each(function() {
							str = $(this).val();
						});
						if (str == 'Future') {
							$('#strike').hide();
							$('#strike').val('100');
						} else {
							$('#strike').show();
							$('#strike').val('');
							$('#addButton').attr('disabled', 'disabled');
						}
					}).trigger("change");
					(function() {
						$('form#addForm input').keyup(function() {
							var empty = false;
							$('form#addForm input').each(function() {
								if ($.trim($(this).val()) == '') {
									empty = true;
								}
							});

							if (empty) {
								$('#addButton').attr('disabled', 'disabled'); // updated according to http://stackoverflow.com/questions/7637790/how-to-remove-disabled-attribute-with-jquery-ie
							} else {
								$('#addButton').removeAttr('disabled'); // updated according to http://stackoverflow.com/questions/7637790/how-to-remove-disabled-attribute-with-jquery-ie
							}
						});
					})()
				});
	</script>
</body>
</html>